/*
 * generated by Xtext 2.18.0.M3
 */
package org.xtext.tcc.mydsl.generator

import java.util.ArrayList
import java.util.Arrays
import java.util.List
import org.eclipse.emf.ecore.resource.Resource
import org.eclipse.xtext.generator.AbstractGenerator
import org.eclipse.xtext.generator.IFileSystemAccess2
import org.eclipse.xtext.generator.IGeneratorContext
import org.xtext.tcc.mydsl.myDsl.Api
import org.xtext.tcc.mydsl.myDsl.Atributo
import org.xtext.tcc.mydsl.myDsl.Entidade
import org.xtext.tcc.mydsl.myDsl.Entidades

/**
 * Generates code from your model files on save.
 * 
 * See https://www.eclipse.org/Xtext/documentation/303_runtime_concepts.html#code-generation
 */
class MyDslGenerator extends AbstractGenerator {

	override void doGenerate(Resource resource, IFileSystemAccess2 fsa, IGeneratorContext context) {
		for (e : resource.allContents.toIterable.filter(Entidades)) {
			fsa.generateFile(e.entidade.nomeEntidade.nome.toFirstUpper.toString + ".java", e.entidade.compile);
			fsa.generateFile(e.entidade.nomeEntidade.nome.toFirstUpper.toString + "Repository.java",
				e.entidade.compileRepository);
			fsa.generateFile(e.entidade.nomeEntidade.nome.toFirstUpper.toString + "Service.java",
				e.entidade.compileService);
			if (e.entidadeMais.size > 0) {
				for (Entidade ent : e.entidadeMais) {
					fsa.generateFile(ent.nomeEntidade.nome.toFirstUpper.toString + ".java", ent.compile);
					fsa.generateFile(ent.nomeEntidade.nome.toFirstUpper.toString + "Repository.java",
						ent.compileRepository);
					fsa.generateFile(ent.nomeEntidade.nome.toFirstUpper.toString + "Service.java", ent.compileService);
				}
			}
		}
		for (a : resource.allContents.toIterable.filter(Api)) {
			fsa.generateFile( "Controller.java", compileController(a));
		}
	}

	def compile(Entidade entidade) '''
		package model;
		import javax.persistence.*;
		import java.sql.*;
		import java.sql.Date;
		import java.util.*;
		
		@Entity
		public class «entidade.nomeEntidade.nome.toFirstUpper» {
			
			@Id
			@GeneratedValue(strategy=GenerationType.IDENTITY)
			private Long id;
			
			«compileAtributos(entidade.atributos.atributo)»
			
			«FOR a : entidade.atributos.atributoMais»
				«compileAtributos(a)»
				
			«ENDFOR»
			public Long getId() {
				return id;
			}
			
			public void setId(Long id) {
				this.id = id;
			}
			
			«compileGetersSeters(entidade.atributos.atributo)»
		
			«FOR a : entidade.atributos.atributoMais»
				«compileGetersSeters(a)»
			«ENDFOR»
		}
	'''

	def compileAtributos(Atributo atributo) '''
		«IF !(atributo.associacao.associacao.equals(""))»
			«IF atributo.operacao === null»
				@«atributo.associacao.associacao»
			«ELSE»
				@«atributo.associacao.associacao»(cascade = {javax.persistence.CascadeType.«atributo.operacao.opCascada.operacao»«FOR o: atributo.operacao.opCascadaMais», CascadeType.«o.operacao»«ENDFOR»})
			«ENDIF»
		«ENDIF»
		«IF atributo.atributoTipo.tipoPrimitivo !== null»
			private «atributo.atributoTipo.tipoPrimitivo.toFirstUpper» «atributo.nomeAtributo.nome.toFirstLower»;
		«ELSEIF atributo.atributoTipo.tipoColecao !== null»
			private «atributo.atributoTipo.tipoColecao.toFirstUpper» «atributo.nomeAtributo.nome.toFirstLower»;
		«ELSE»
			private «atributo.atributoTipo.tipoObjeto.toFirstUpper» «atributo.nomeAtributo.nome.toFirstLower»;
		«ENDIF»
	'''

	def compileGetersSeters(Atributo atributo) '''
		«IF atributo.atributoTipo.tipoPrimitivo !== null»
			public «atributo.atributoTipo.tipoPrimitivo» get«atributo.nomeAtributo.nome.toFirstUpper»(){
				return «atributo.nomeAtributo.nome»;
			}
			
			public void set«atributo.nomeAtributo.nome.toFirstUpper»(« atributo.atributoTipo.tipoPrimitivo» «atributo.nomeAtributo.nome»){
				this.«atributo.nomeAtributo.nome» = «atributo.nomeAtributo.nome»;
			}
		«ELSEIF atributo.atributoTipo.tipoColecao !== null»
			public «atributo.atributoTipo.tipoColecao» get«atributo.nomeAtributo.nome.toFirstUpper»(){
				return «atributo.nomeAtributo.nome»;
			}
			
			public void set«atributo.nomeAtributo.nome.toFirstUpper»(«atributo.atributoTipo.tipoColecao» «atributo.nomeAtributo.nome»){
				this.«atributo.nomeAtributo.nome» = «atributo.nomeAtributo.nome»;
			}
		«ELSE»
			public «atributo.atributoTipo.tipoObjeto.toFirstUpper» get«atributo.nomeAtributo.nome.toFirstUpper»(){
				return «atributo.nomeAtributo.nome»;
			}
							
			public void set«atributo.nomeAtributo.nome.toFirstUpper»(«atributo.atributoTipo.tipoObjeto.toFirstUpper» «atributo.nomeAtributo.nome»){
				this.«atributo.nomeAtributo.nome» = «atributo.nomeAtributo.nome»;
			}
		«ENDIF»
	'''

	def compileRepository(Entidade entidade) '''
		package repository;
		import org.springframework.data.jpa.repository.JpaRepository;
		import org.springframework.stereotype.Repository;
		import model.«entidade.nomeEntidade.nome.toFirstUpper»;
		
		@Repository
		public interface «entidade.nomeEntidade.nome.toFirstUpper»Repository extends JpaRepository<«entidade.nomeEntidade.nome.toFirstUpper», Long>{
		
		}
		
	'''

	def compileService(Entidade entidade) '''
		package service;
		
		import java.util.List;
		import org.springframework.beans.factory.annotation.Autowired;
		import org.springframework.stereotype.Service;
		
		import model.«entidade.nomeEntidade.nome.toFirstUpper»;
		import repository.«entidade.nomeEntidade.nome.toFirstUpper»Repository;
		
		«FOR ent: getTipoAtributos(entidade)»
			import model.«ent.toFirstUpper»
		«ENDFOR»
		
		@Service
		public class «entidade.nomeEntidade.nome.toFirstUpper»Service {
			
			@Autowired
			«entidade.nomeEntidade.nome.toFirstUpper»Repository «entidade.nomeEntidade.nome.toFirstLower»Repository;
			
			public void save(«entidade.nomeEntidade.nome.toFirstUpper» «entidade.nomeEntidade.nome.toFirstLower») {
				«entidade.nomeEntidade.nome.toFirstLower»Repository.save(«entidade.nomeEntidade.nome.toFirstLower»);
			}
			
			public List<«entidade.nomeEntidade.nome.toFirstUpper»> get«entidade.nomeEntidade.nome.toFirstUpper»s(){
				return «entidade.nomeEntidade.nome.toFirstLower»Repository.findAll();
			}
			
			public «entidade.nomeEntidade.nome.toFirstUpper» get«entidade.nomeEntidade.nome.toFirstUpper»ById(Long id) {
				return «entidade.nomeEntidade.nome.toFirstLower»Repository.getOne(id);
			}
			
			public void deleteAll«entidade.nomeEntidade.nome.toFirstUpper»() {
				«entidade.nomeEntidade.nome.toFirstLower»Repository.deleteAll();
			}
			
			public void delete«entidade.nomeEntidade.nome.toFirstUpper»(Long id) {
				«entidade.nomeEntidade.nome.toFirstLower»Repository.deleteById(id);
			}
				
			public boolean exists«entidade.nomeEntidade.nome.toFirstUpper»ById(Long id) {
				return «entidade.nomeEntidade.nome.toFirstLower»Repository.existsById(id);
			}
			
			«IF entidade.atributos.atributo.associacao.associacao.equals("OneToOne") || entidade.atributos.atributo.associacao.associacao.equals("ManyToOne")»
				public void update(Long id, «entidade.atributos.atributo.atributoTipo.tipoObjeto.toFirstUpper» «entidade.atributos.atributo.atributoTipo.tipoObjeto.toFirstLower»){
					«entidade.nomeEntidade.nome.toFirstUpper» «entidade.nomeEntidade.nome.toFirstLower» = get«entidade.nomeEntidade.nome.toFirstUpper»ById(id);
					«entidade.nomeEntidade.nome.toFirstLower».set«entidade.atributos.atributo.nomeAtributo.nome.toFirstUpper»(«entidade.atributos.atributo.atributoTipo.tipoObjeto.toFirstLower»);
					«entidade.nomeEntidade.nome.toFirstLower»Repository.save(«entidade.nomeEntidade.nome.toFirstLower»);
				}
			«ELSEIF entidade.atributos.atributo.associacao.associacao.equals("OneToMany") || entidade.atributos.atributo.associacao.associacao.equals("ManyToMany")»
				«var nome = getNomeTipoColecao(entidade.atributos.atributo.atributoTipo.tipoColecao)»
				public void update(Long id, «nome.toFirstUpper» «nome.toFirstLower») {
					«entidade.nomeEntidade.nome.toFirstUpper» «entidade.nomeEntidade.nome» = get«entidade.nomeEntidade.nome.toFirstUpper»ById(id);
					«entidade.nomeEntidade.nome.toFirstLower».get«entidade.atributos.atributo.nomeAtributo.nome.toFirstUpper»s().add(«nome.toFirstLower»);
					«entidade.nomeEntidade.nome.toFirstLower»Repository.save(«entidade.nomeEntidade.nome.toFirstLower»);
				}
			«ENDIF»
		
			«FOR atributo: entidade.atributos.atributoMais»
				«IF atributo.associacao.associacao.equals("OneToOne") || atributo.associacao.associacao.equals("ManyToOne")»
					public void update(Long id, «atributo.atributoTipo.tipoObjeto.toFirstUpper» «atributo.atributoTipo.tipoObjeto»){
						«entidade.nomeEntidade.nome.toFirstUpper» «entidade.nomeEntidade.nome.toFirstLower» = get«entidade.nomeEntidade.nome.toFirstUpper»ById(id);
						«entidade.nomeEntidade.nome.toFirstLower».set«atributo.nomeAtributo.nome.toFirstUpper»(«atributo.atributoTipo.tipoObjeto»);
						«entidade.nomeEntidade.nome.toFirstLower»Repository.save(«entidade.nomeEntidade.nome.toFirstLower»);
					}
				«ELSEIF atributo.associacao.associacao.equals("OneToMany") || atributo.associacao.associacao.equals("ManyToMany")»
					«var nome = getNomeTipoColecao(atributo.atributoTipo.tipoColecao)»
					public void update(Long id, «nome.toFirstUpper» «nome») {
						«entidade.nomeEntidade.nome.toFirstUpper» «entidade.nomeEntidade.nome.toFirstLower» = get«entidade.nomeEntidade.nome.toFirstUpper»ById(id);
						«entidade.nomeEntidade.nome.toFirstLower».get«atributo.nomeAtributo.nome.toFirstUpper»().add(«nome»);
						«entidade.nomeEntidade.nome.toFirstLower»Repository.save(«entidade.nomeEntidade.nome.toFirstLower»);
					}
				«ENDIF»
			«ENDFOR»
		}
	'''
		
	def getTipoAtributos(Entidade entidade) {
		
		var ArrayList<String> tipos = new ArrayList();
		
		var List<String> tiposPrimitivos = new ArrayList(
			Arrays.asList("Boolean", "Integer", "Long", "String", "Float", "Double", "Time", "Timestamp", "Date"));
			
		if(entidade.atributos.atributo. atributoTipo.tipoObjeto !== null){
			tipos.add(entidade.atributos.atributo. atributoTipo.tipoObjeto)
		}else if(entidade.atributos.atributo. atributoTipo.tipoColecao !== null){
			var String nome = getNomeTipoColecao(entidade.atributos.atributo. atributoTipo.tipoColecao)
			if(!tiposPrimitivos.contains(nome)){
				tipos.add(entidade.atributos.atributo. atributoTipo.tipoObjeto)
			}
		}
		
		if(entidade.atributos.atributoMais.size > 0){
			for(a : entidade.atributos.atributoMais){
				if(a.atributoTipo.tipoObjeto !== null){
					tipos.add(a.atributoTipo.tipoObjeto)
				}else if(a.atributoTipo.tipoColecao !== null){
					var String nome = getNomeTipoColecao(a.atributoTipo.tipoColecao)
					if(!tiposPrimitivos.contains(nome)){
						tipos.add(nome)
					}
				}
			}
		}
		
		return tipos;	
	}
	
	def getNomeTipoColecao(String nomeTipo) {
		var int inicio = 0;
		var int fim = 0;
		for (var int i = 0; i < nomeTipo.length; i++) {
			var c = nomeTipo.charAt(i).toString;
			if (c == '<') {
				inicio = i
			}
			if (c.equals(">")) {
				fim = i
			}
		}
		var nome = nomeTipo.substring(inicio + 1, fim);
		return nome;
	}
	
	def compileController(Api api) '''
		package controller;
		import java.util.*;
		import org.springframework.beans.factory.annotation.Autowired;
		import org.springframework.http.*;
		import org.springframework.web.bind.annotation.*;
		
		import model.*;
		import service.*;
		
		@RestController
		@RequestMapping("/«api.nomeApi.nome»-api")
		public class HomeController {
			
			@Autowired
			«api.entidades.entidade.nomeEntidade.nome.toFirstUpper»Service «api.entidades.entidade.nomeEntidade.nome.toFirstLower»Service;
			
			«FOR entidade: api.entidades.entidadeMais»
			@Autowired
			«entidade.nomeEntidade.nome.toFirstUpper»Service «entidade.nomeEntidade.nome.toFirstLower»Service;
			
			«ENDFOR»
			
			«compileMetodosController(api.entidades.entidade)»
			
			«FOR e: api.entidades.entidadeMais»
				«compileMetodosController(e)»
			«ENDFOR»
			
		}
	'''
	
	def compileMetodosController(Entidade entidade) '''
		@PostMapping(value = "/«entidade.nomeEntidade.nome.toFirstLower»s", consumes = MediaType.APPLICATION_JSON_VALUE)
		public ResponseEntity<«entidade.nomeEntidade.nome.toFirstUpper»> save«entidade.nomeEntidade.nome.toFirstUpper»(@RequestBody «entidade.nomeEntidade.nome.toFirstUpper» «entidade.nomeEntidade.nome.toFirstLower») {
			if («entidade.nomeEntidade.nome.toFirstLower» == null || «entidade.nomeEntidade.nome.toFirstLower»Service.exists«entidade.nomeEntidade.nome.toFirstUpper»ById(«entidade.nomeEntidade.nome.toFirstLower».getId())) {
				return new ResponseEntity<>(HttpStatus.BAD_REQUEST);
			}
		
			this.«entidade.nomeEntidade.nome.toFirstLower»Service.save(«entidade.nomeEntidade.nome.toFirstLower»);
		
			return new ResponseEntity<«entidade.nomeEntidade.nome.toFirstUpper»>(«entidade.nomeEntidade.nome.toFirstLower», HttpStatus.CREATED);
		}
			
		@GetMapping(value = "/«entidade.nomeEntidade.nome.toFirstLower»s", produces = MediaType.APPLICATION_JSON_VALUE)
		public ResponseEntity<List<«entidade.nomeEntidade.nome.toFirstUpper»>> get«entidade.nomeEntidade.nome.toFirstUpper»s() {
			List<«entidade.nomeEntidade.nome.toFirstUpper»> «entidade.nomeEntidade.nome.toFirstLower»s = this.«entidade.nomeEntidade.nome.toFirstLower»Service.get«entidade.nomeEntidade.nome.toFirstUpper»s();
			return new ResponseEntity<List<«entidade.nomeEntidade.nome.toFirstUpper»>>(«entidade.nomeEntidade.nome.toFirstLower»s, HttpStatus.OK);
		}
		
		@GetMapping(value = "/«entidade.nomeEntidade.nome.toFirstLower»s/{id}", produces = MediaType.APPLICATION_JSON_VALUE)
		public ResponseEntity<«entidade.nomeEntidade.nome.toFirstUpper»> get«entidade.nomeEntidade.nome.toFirstUpper»(@PathVariable("id") Long id) {
			if (id == null) {
				return new ResponseEntity<>(HttpStatus.BAD_REQUEST);
			}
				
			if(!«entidade.nomeEntidade.nome.toFirstLower»Service.exists«entidade.nomeEntidade.nome.toFirstUpper»ById(id)) {
				return new ResponseEntity<>(HttpStatus.NOT_FOUND);
			}
				
			«entidade.nomeEntidade.nome.toFirstUpper» «entidade.nomeEntidade.nome.toFirstLower» = «entidade.nomeEntidade.nome.toFirstLower»Service.get«entidade.nomeEntidade.nome.toFirstUpper»ById(id);
		
			return new ResponseEntity<«entidade.nomeEntidade.nome.toFirstUpper»>(«entidade.nomeEntidade.nome.toFirstLower», HttpStatus.OK);
		}
		
		@DeleteMapping(value = "/«entidade.nomeEntidade.nome.toFirstLower»s")
		public ResponseEntity<String> deleteAll«entidade.nomeEntidade.nome.toFirstUpper»() {
			«entidade.nomeEntidade.nome.toFirstLower»Service.deleteAll«entidade.nomeEntidade.nome.toFirstUpper»();
			return new ResponseEntity<String>("«entidade.nomeEntidade.nome.toFirstUpper»s removidos com sucesso.", HttpStatus.OK);
		}
		
		@DeleteMapping(value = "/«entidade.nomeEntidade.nome.toFirstLower»s/{id}")
		public ResponseEntity<String> delete«entidade.nomeEntidade.nome.toFirstUpper»(@PathVariable("id") Long id) {
			if (id == null) {
				return new ResponseEntity<>(HttpStatus.BAD_REQUEST);
			}
				
			if(!«entidade.nomeEntidade.nome.toFirstLower»Service.exists«entidade.nomeEntidade.nome.toFirstUpper»yId(id)) {
				return new ResponseEntity<>(HttpStatus.NOT_FOUND);
			}
				
			«entidade.nomeEntidade.nome.toFirstLower»Service.delete«entidade.nomeEntidade.nome.toFirstUpper»(id);
		
			return new ResponseEntity<String>("«entidade.nomeEntidade.nome.toFirstUpper» removido com sucesso.", HttpStatus.OK);
		}
		
		«IF entidade.atributos.atributo.associacao !== null»
			«compileAssociacao(entidade.atributos.atributo, entidade.nomeEntidade.nome)»
		«ENDIF»
		
		«FOR a: entidade.atributos.atributoMais»
			«compileAssociacao(a, entidade.nomeEntidade.nome)»
		«ENDFOR»
		 
	'''
	
	def compileAssociacao(Atributo atributo, String nomeEntidade) '''
		«IF atributo.associacao.associacao.equals("OneToOne") || atributo.associacao.associacao.equals("ManyToOne")»
		@PutMapping(value = "/«nomeEntidade.toFirstLower»s-«atributo.atributoTipo.tipoObjeto»/{«nomeEntidade.toFirstLower»Id}/{«atributo.atributoTipo.tipoObjeto.toFirstLower»Id}", consumes = MediaType.APPLICATION_JSON_VALUE)
		public ResponseEntity associa«atributo.atributoTipo.tipoObjeto.toFirstUpper»To«nomeEntidade.toFirstUpper»(@PathVariable("«nomeEntidade.toFirstLower»Id") Long «nomeEntidade.toFirstLower»Id,
			@PathVariable("«atributo.atributoTipo.tipoObjeto.toFirstLower»Id") Long «atributo.atributoTipo.tipoObjeto.toFirstLower»Id) {
			if (!«nomeEntidade.toFirstLower»Service.exists«nomeEntidade.toFirstUpper»yId(«nomeEntidade.toFirstLower»Id)) {
				return new ResponseEntity<>(HttpStatus.NOT_FOUND);
			}
			if (!«atributo.atributoTipo.tipoObjeto.toFirstLower»Service.exists«atributo.atributoTipo.tipoObjeto.toFirstUpper»ById(«atributo.atributoTipo.tipoObjeto.toFirstLower»Id)) {
				return new ResponseEntity<>(HttpStatus.NOT_FOUND);
			}
							
			«atributo.atributoTipo.tipoObjeto.toFirstUpper» «atributo.atributoTipo.tipoObjeto.toFirstLower» = «atributo.atributoTipo.tipoObjeto.toFirstLower»Service.get«atributo.atributoTipo.tipoObjeto.toFirstUpper»ById(«atributo.atributoTipo.tipoObjeto.toFirstLower»Id);
			this.«nomeEntidade.toFirstLower»Service.update(«nomeEntidade.toFirstLower»Id, «atributo.atributoTipo.tipoObjeto.toFirstLower»);
							
			return new ResponseEntity("Ok.", HttpStatus.OK);
		}
		«ELSEIF atributo.associacao.associacao.equals("OneToMany") || atributo.associacao.associacao.equals("ManyToMany")»
		«var String nome = getNomeTipoColecao(atributo.atributoTipo.tipoColecao)»
		@PutMapping(value = "/«nomeEntidade.toFirstLower»s-«nome.toFirstLower»/{pessoaId}/{«nome.toFirstLower»Id}", consumes = MediaType.APPLICATION_JSON_VALUE)
		public ResponseEntity add«nome.toFirstUpper»To«nomeEntidade.toFirstUpper»(@PathVariable("«nomeEntidade.toFirstLower»Id") Long «nomeEntidade.toFirstLower»Id,
			@PathVariable("«nome.toFirstLower»Id") Long «nome.toFirstLower»Id) {			
			if (!«nomeEntidade.toFirstLower»Service.exists«nomeEntidade.toFirstUpper»ById(«nomeEntidade.toFirstLower»Id)) {
				return new ResponseEntity(HttpStatus.NOT_FOUND);
			}
			if (!«nome.toFirstLower»Service.exists«nome.toFirstUpper»ById(«nome.toFirstLower»d)) {
				return new ResponseEntity(HttpStatus.NOT_FOUND);
			}
							
			«nome.toFirstUpper» «nome.toFirstLower» = «nome.toFirstLower»Service.get«nome.toFirstUpper»ById(«nome.toFirstLower»Id);
			«nomeEntidade.toFirstLower»Service.update(«nomeEntidade.toFirstLower»Id, «nome.toFirstLower»);
							
			return new ResponseEntity(HttpStatus.OK);
		}
		«ENDIF»
	'''
}
